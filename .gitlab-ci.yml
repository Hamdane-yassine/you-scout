default:
  tags:
    - docker
stages:
  - scan
  - version
  - build
  - deploy
  - triggers

variables:
  variable_value: value

scan_code:
  image: registry.gitlab.com/gitlab-org/security-products/analyzers/semgrep:latest
  stage: scan
  script:
    - semgrep --config auto -o gl-sast-report.json .
  artifacts:
    reports:
      sast: gl-sast-report.json




social-graph-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd social-graph-service
    - export VERSION=$GRAPH_VERSION
  script: |
    mvn compile jib:build \
    -Djib.to.auth.username=${CI_REGISTRY_USER} \
    -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  cache:
    paths:
      - .m2/repository/
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    reports:
      junit:
        - "post-handling-service/target/*-reports/TEST-*.xml"
  # artifacts:
  #   paths:
  #     - social-graph-service/target/*.jar
  rules:
    # - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    #   allow_failure: true
    # - if: '$CI_COMMIT_TAG =~ /auth-service/'
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_TAG == "major-social-graph-service" || $CI_COMMIT_TAG == "minor-social-graph-service" || $CI_COMMIT_TAG == "patch-social-graph-service"'
      changes:
      - social-graph-service/**/*

user-feed-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd user-feed-service
    - export VERSION=$FEED_VERSION
  script: |
    mvn compile jib:build \
      -Djib.to.auth.username=${CI_REGISTRY_USER} \
      -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  cache:
    paths:
      - .m2/repository/
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    reports:
      junit:
        - "user-feed-service/target/*-reports/TEST-*.xml"
  # artifacts:
  #   paths:
  #     - user-feed-service/target/*.jar
  rules:
    # - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    #   allow_failure: true
    # - if: '$CI_COMMIT_TAG =~ /auth-service/'
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_TAG == "major-user-feed-service" || $CI_COMMIT_TAG == "minor-user-feed-service" || $CI_COMMIT_TAG == "patch-user-feed-service"'
      changes:
        - user-feed-service/**/*



social_graph_yaml:
  stage: deploy
  script: |
    sed -i 's|image:.*|image: registry.gitlab.com/hamdane10/you-scout/social-graph-service:'$GRAPH_VERSION'|' k8s/social-graph-service.yaml
    ENCODED_CONTENT=$(base64 -w 0 k8s/social-graph-service.yaml)
    curl --request PUT --header "PRIVATE-TOKEN: glpat-yw5_V7QMKPXSt52tdx5B" "https://gitlab.com/api/v4/projects/44998572/repository/files/k8s%2Fsocial-graph-service%2Eyaml" --header "Content-Type: application/json" --data '{"branch": "master", "author_email": "aarrasseayoub@gmail.com", "author_name": "Ayoub AARRASSE", "content": "'"$DECODED_CONTENT"'", "commit_message": "update file", "encoded":"base64"}'
  rules:
    - if: '$CI_COMMIT_TAG == "major-social-graph-service" || $CI_COMMIT_TAG == "minor-social-graph-service" || $CI_COMMIT_TAG == "patch-social-graph-service"'
      changes:
        - social-graph-service/**/*
  needs:
    - job: social-graph-build


feed_yaml:
  stage: deploy
  script: |
    sed -i 's|image:.*|image: registry.gitlab.com/hamdane10/you-scout/user-feed-service:'$FEED_VERSION'|' k8s/user-feed-service.yaml
    ENCODED_CONTENT=$(base64 -w 0 k8s/user-feed-service.yaml)
    curl --request PUT --header "PRIVATE-TOKEN: glpat-yw5_V7QMKPXSt52tdx5B" "https://gitlab.com/api/v4/projects/44998572/repository/files/k8s%2Fuser-feed-service%2Eyaml" --header "Content-Type: application/json" --data '{"branch": "master", "author_email": "aarrasseayoub@gmail.com", "author_name": "Ayoub AARRASSE", "content": "'"$DECODED_CONTENT"'", "commit_message": "update file","encoded":"base64"}'
  rules:
    - if: '$CI_COMMIT_TAG == "major-user-feed-service" || $CI_COMMIT_TAG == "minor-user-feed-service" || $CI_COMMIT_TAG == "patch-user-feed-service"'
      changes:
        - user-feed-service/**/*
  needs:
    - job: user-feed-build



trigger_auth:
  stage: triggers
  trigger:
    include: auth-service/.gitlab-ci.yml
  rules:
    - changes:
        - auth-service/**/*

trigger_comment:
  stage: triggers
  trigger:
    include: comments-service/.gitlab-ci.yml
  rules:
    - changes:
        - comments-service/**/*

trigger_post:
  stage: triggers
  trigger:
    include: post-service/.gitlab-ci.yml
  rules:
    - changes:
        - post-service/**/*

trigger_skill:
  stage: triggers
  trigger:
    include: skills-service/.gitlab-ci.yml
  rules:
    - changes:
        - skills-service/**/*





