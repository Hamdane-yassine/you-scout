default:
  tags:
    - Windows


stages:
  - build


variables:
  # SAST_IMAGE_SUFFIX: '-fips'
  VERSION_TAG: $CI_PIPELINE_IID
  VERSION_FILE: version.txt
  SERVICES: value






authentication-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd auth-service
    - export PACKAGE_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
    - export IMAGE_NAME=$CI_REGISTRY_IMAGE/microservice/authentication
    - VERSION=$(cat $VERSION_FILE)
    - export VERSION=$(cat $VERSION_FILE)
  script: |
    mvn compile jib:build \
      -Djib.to.auth.username=${CI_REGISTRY_USER} \
      -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    reports:
      junit:
        - "auth-service/target/*-reports/TEST-*.xml"
  cache:
    paths:
      - .m2/repository/
  # only:
  #   changes:
  #     - auth-service/**/*


social-graph-build:
  image:  maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd social-graph-service
  script: |
    mvn compile jib:build \
    -Djib.to.auth.username=${CI_REGISTRY_USER} \
    -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  artifacts:
    paths:
      - social-graph-service/target/*.jar
  only:
    changes:
      - social-graph-service/**/*


post-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd post-service
  script: "mvn package -B"
  artifacts:
    paths:
      - post-service/target/*.jar.original
  only:
    changes:
      - post-service/**/*



user-feed-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd user-feed-service
  script: "mvn package -B"
  artifacts:
    paths:
      - user-feed-service/target/*.jar
  cache:
    paths:
      - .m2/repository/
      - user-feed-service/target
  only:
    changes:
      - user-feed-service/**/*


comments-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd comments-service
  script:
    - echo "Running build job"
    - mvn package -B
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - comments-service/.m2/repository/
  artifacts:
    paths:
      - comments-service/target/*.jar
  only:
    changes:
      - comments-service/**/*


skills-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd skills-service
  script:
    - mvn package -B
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - skills-service/.m2/repository/
  artifacts:
    paths:
      - skills-service/target/*.jar
  only:
    changes:
      - skills-service/**/*

.increment_major:
  stage: build
  script:
    - cd $SERVICE
    - echo "Incrementing Major version"
    - VERSION=$(cat $VERSION_FILE)
    - IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
    - VERSION_MAJOR=$((VERSION_PARTS[0] + 1))
    - echo "$VERSION_MAJOR.0.0" > $VERSION_FILE
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_NAME == "increment-major-$SERVICE"'

increment_minor:
  stage: build
  script:
    - echo "Incrementing Minor version"
    - VERSION=$(cat $VERSION_FILE)
    - IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
    - VERSION_MINOR=$((VERSION_PARTS[1] + 1))
    - echo "${VERSION_PARTS[0]}.$VERSION_MINOR.0" > $VERSION_FILE
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_NAME == "increment-minor"'

increment_patch:
  stage: build
  script:
    - echo "Incrementing Patch version"
    - VERSION=$(cat $VERSION_FILE)
    - IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
    - VERSION_PATCH=$((VERSION_PARTS[2] + 1))
    - echo "${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$VERSION_PATCH" > $VERSION_FILE
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_NAME == "increment-patch"'

major_auth:
  extends: .increment_major
  variables:
    SERVICE: "auth-service"
major_graph:
  extends: .increment_major
  variables:
    SERVICE: "social-graph-service"
major_post:
  extends: .increment_major
  variables:
    SERVICE: "post-handling-service"
major_feed:
  extends: .increment_major
  variables:
    SERVICE: "feed-service"
major_comment:
  extends: .increment_major
  variables:
    SERVICE: "comment-service"
major_skill:
  extends: .increment_major
  variables:
    SERVICE: "skills-service"


