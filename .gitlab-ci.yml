default:
  tags:
    - Windows


stages:
  - build
  

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=user-feed-service/.m2/repository"
  VERSION_TAG: $CI_PIPELINE_IID
   
    


authentication-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd auth-service
    - export PACKAGE_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
    - export IMAGE_NAME=$CI_REGISTRY_IMAGE/microservice/authentication
    - export IMAGE_TAG=1.3
  script: build MAVEN_CLI_OPTS package
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    reports:
      junit:
        - "auth-service/target/*-reports/TEST-*.xml"
  only:
    changes:
      - auth-service/**/*


social-graph-build:
  image:  maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd social-graph-service
  script: "mvn package -B"
  artifacts:
    paths:
      - social-graph-service/target/*.jar
  only:
    changes:
      - social-graph-service/**/*


post-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd post-service
  script: "mvn package -B"
  artifacts:
    paths:
      - post-service/target/*.jar.original
  # only:
  #   changes:
  #     - post-service/**/*


user-feed-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd user-feed-service
  script: "mvn package -B"
  artifacts:
    paths:
      - user-feed-service/target/*.jar
  cache:
    paths:
      - .m2/repository/
      - user-feed-service/target
  only:
    changes:
      - user-feed-service/**/*


comments-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd comments-service
  script:
    - echo "Running build job"
    - mvn package -B
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - comments-service/.m2/repository/
  artifacts:
    paths:
      - comments-service/target/*.jar
  only:
    changes:
      - comments-service/**/*


skills-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd skills-service
  script:
    - mvn package -B
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - skills-service/.m2/repository/
  artifacts:
    paths:
      - skills-service/target/*.jar
  only:
    changes:
      - skills-service/**/*



# docker-build:
#   stage: build
#   before_script:
#     - docker login -u dall49 -p $DOCKER_HUB_PASSWORD
#   script:
#     - docker build -t dall49/product-microservice:$TAG .
#     - docker push dall49/product-microservice:$TAG

# include:
#   - template: Security/SAST.gitlab-ci.yml
