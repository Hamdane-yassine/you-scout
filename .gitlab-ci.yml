default:
  tags:
    - Windows

stages:
  - scan
  - version
  - build
  - deploy



variables:
  VERSION_TAG: $CI_PIPELINE_IID
  VERSION_FILE: version.txt
  SERVICES: value
  variable_value: value
  CONTAINER_RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest

scan_code:
  image: registry.gitlab.com/gitlab-org/security-products/analyzers/semgrep:latest
  stage: scan
  script:
    - semgrep --config auto -o gl-sast-report.json .
  artifacts:
    reports:
      sast: gl-sast-report.json



versioning:
  stage: version
  script:
    - variable_value=$CI_COMMIT_REF_NAME
    - echo "Variable value $variable_value"
    - IFS='-' read -ra words <<< "$variable_value"
    - word1="${words[0]}"
    - word2=$(echo "$variable_value" | cut -d'-' -f2-)
    - echo $word1
    - echo $word2
    - variable_name="${word1}-${word2}"
    - echo "$COMMENT_VERSION"
    - |
      case "$word2" in
        "auth-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$AUTH_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
          echo "major $MAJOR, minor $MINOR, patch $PATCH"
          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/AUTH_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        "social-graph-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$GRAPH_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            echo "I'm really in"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
      
          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/GRAPH_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        "post-handling-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$POST_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            echo "I'm really in"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
      
          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/POST_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        "user-feed-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$FEED_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            echo "I'm really in"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
      
          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/FEED_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        "comments-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$COMMENT_VERSION"
          echo "$COMMENT_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            echo "I'm really in"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
          echo "major $MAJOR, minor $MINOR, patch $PATCH"

          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/COMMENT_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        "skills-service")
          echo "I'm in"
          IFS='.' read -ra VERSION_ARRAY <<< "$SKILL_VERSION"
          MAJOR=${VERSION_ARRAY[0]}
          MINOR=${VERSION_ARRAY[1]}
          PATCH=${VERSION_ARRAY[2]}
          if [[ $word1 == "major" ]]; then
            echo "I'm really in"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [[ $word1 == "minor" ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $word1 == "patch" ]]; then
            PATCH=$((PATCH + 1))
          fi
      
          curl --request PUT --header "PRIVATE-TOKEN: glpat-rzjTbhoKA5VmBypsnB6n" "https://gitlab.com/api/v4/projects/44998572/variables/SKILL_VERSION" --form "value=$MAJOR.$MINOR.$PATCH"
          ;;
        *)
          echo "Invalid value or no matching case"
          ;;
      
      esac
  rules:
    - if: '$CI_COMMIT_TAG'

deploy:
  stage: deploy
  image: alpine
  script: |
    sed -i "s|image:.*|image: registry.gitlab.com/hamdane10/you-scout/comments-service:$COMMENT_VERSION|g" k8s/auth-service.yaml
    apk add --no-cache git
    git config --global user.name "oussamaZAAM"
    git config --global user.email "zaam.oussama@gmail"
    git checkout master
    git add k8s/auth-service.yaml
    git commit -m "Update image reference in deployment.yaml"
    git push origin master






authentication-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd auth-service
    - export PACKAGE_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
    - export IMAGE_NAME=$CI_REGISTRY_IMAGE/microservice/authentication
    - export VERSION=$AUTH_VERSION
  script: |
    mvn compile jib:build \
      -Djib.to.auth.username=${CI_REGISTRY_USER} \
      -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  artifacts:
    name: "Maven artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    reports:
      junit:
        - "auth-service/target/*-reports/TEST-*.xml"
  cache:
    paths:
      - .m2/repository/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /auth-service/'
    - changes:
      - auth-service/**/*


social-graph-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd social-graph-service
  script: |
    mvn compile jib:build \
    -Djib.to.auth.username=${CI_REGISTRY_USER} \
    -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
  artifacts:
    paths:
      - social-graph-service/target/*.jar
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /social-graph-service/'
    - changes:
      - social-graph-service/**/*


post-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd post-service
  script: "mvn package -B"
  artifacts:
    paths:
      - post-service/target/*.jar.original
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /post-handling-service/'
    - changes:
      - post-service/**/*



user-feed-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd user-feed-service
  script: "mvn package -B"
  artifacts:
    paths:
      - user-feed-service/target/*.jar
  cache:
    paths:
      - .m2/repository/
      - user-feed-service/target
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /user-feed-service/'
    - changes:
      - user-feed-service/**/*

comments-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd comments-service
    - echo "$COMMENT_VERSION"
    - export VERSION="$COMMENT_VERSION"
  script:
    - echo "$COMMENT_VERSION"
    - mvn compile jib:build -Djib.to.auth.username=$CI_REGISTRY_USER -Djib.to.auth.password=$CI_REGISTRY_PASSWORD -Djib.to.image=$CONTAINER_RELEASE_IMAGE
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .m2/repository/
  artifacts:
    paths:
      - comments-service/target/*.jar

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /comments-service/'
    - changes:
      - comment-service/**/*


skills-service-build:
  image: maven:3.8.4-openjdk-17
  stage: build
  before_script:
    - cd skills-service
    - export VERSION=$(cat $VERSION_FILE)
  script:
    - mvn compile jib:build \
      -Djib.to.auth.username=${CI_REGISTRY_USER} \
      -Djib.to.auth.password=${CI_REGISTRY_PASSWORD} \
      -Djib.to.image=${CI_REGISTRY_IMAGE}
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .m2/repository/
  artifacts:
    paths:
      - skills-service/target/*.jar
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      allow_failure: true
    - if: '$CI_COMMIT_TAG =~ /skills-service/'
    - changes:
      - skills-service/**/*


 





